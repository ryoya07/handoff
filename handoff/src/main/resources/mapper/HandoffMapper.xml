<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	
<mapper namespace="com.example.handoff.repository.HandoffMapper">

  <select id="selectAll" resultType="com.example.handoff.domain.view.HandoffView">
	  SELECT
	    h.id,
	    h.title,
	    h.content,
	    h.created_by AS createdById, 
	    u.display_name AS createdByName,
	    h.created_at AS createdAt,
	    CASE WHEN r.read_at IS NULL THEN 0 ELSE 1 END AS readFlag,
	    r.read_at AS readAt
	  FROM handoffs h
	  JOIN users u ON h.created_by = u.id
	  LEFT JOIN handoff_reads r
	    ON r.handoff_id = h.id
	   AND r.user_id = #{loginUserId}
	  ORDER BY h.created_at DESC
</select>
  
<insert id="insert">
	INSERT INTO handoffs (title, content, created_by)
	VALUES (#{title}, #{content}, #{createdBy})
</insert>
  
<select id="selectById" resultType="com.example.handoff.domain.HandoffEdit">
  SELECT
    id,
    title,
    content,
    created_by AS createdBy,
    created_at AS createdAt,
    updated_at AS updatedAt
  FROM handoffs
  WHERE id = #{id}
</select>

<update id="updateByIdAndUserId">
  UPDATE handoffs
  SET
    title = #{title},
    content = #{content},
    updated_at = NOW()
  WHERE id = #{id}
    AND created_by = #{userId}
</update>

<delete id="deleteByIdAndUserId">
  DELETE FROM handoffs
  WHERE id = #{id}
    AND created_by = #{userId}
</delete>

<select id="selectByIdWithReadFlag" resultType="com.example.handoff.domain.view.HandoffView">
  SELECT
    h.id,
    h.title,
    h.content,
    h.created_by AS createdById,
    u.display_name AS createdByName,
    h.created_at AS createdAt,
    CASE WHEN hr.user_id IS NULL THEN 0 ELSE 1 END AS readFlag
  FROM handoffs h
  JOIN users u
    ON u.id = h.created_by
  LEFT JOIN handoff_reads hr
    ON hr.handoff_id = h.id
   AND hr.user_id = #{userId}
  WHERE h.id = #{id}
</select>
  
</mapper>